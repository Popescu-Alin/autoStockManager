<div class="car-details-container">
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-with-text">
      <div class="loading-spinner"></div>
      <span class="loading-text">Loading car details...</span>
    </div>
  </div>

  <div *ngIf="!isLoading && car" class="car-details-content">
    <div class="header-actions">
      <a routerLink="/home" class="back-button">
        <i class="pi pi-arrow-left"></i>
        Back
      </a>
      <div class="action-buttons" *ngIf="isAdmin">
        <button
          pButton
          type="button"
          label="Edit Car"
          icon="pi pi-pencil"
          (click)="openEditCarDialog()"
          class="p-button-secondary"
        ></button>
        <button
          pButton
          type="button"
          label="Add Car Part"
          icon="pi pi-cog"
          (click)="openAddCarPartDialog()"
          class="p-button-primary"
        ></button>
        <button
          pButton
          type="button"
          label="Delete Car"
          icon="pi pi-trash"
          (click)="deleteCar()"
          class="p-button-danger"
        ></button>
      </div>
    </div>

    <div class="car-header">
      <h1>{{ car?.car?.brand }} {{ car?.car?.model }}</h1>
      <p class="car-year">{{ car?.car?.manufactureYear }}</p>
    </div>

    <div class="car-main-content">
      <div class="car-images-section">
        <div *ngIf="car.images && car.images.length > 0" class="car-images">
          <div *ngFor="let image of car.images" class="car-image">
            <img [src]="image" [alt]="car?.car?.brand + ' ' + car?.car?.model" />
          </div>
        </div>
        <div *ngIf="!car.images || car.images.length === 0" class="no-images">
          <i class="pi pi-image"></i>
          <p>No images available</p>
        </div>
      </div>

      <div class="car-info-section">
        <div class="info-card">
          <h2>Car Information</h2>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Brand:</span>
              <span class="info-value">{{ car?.car?.brand }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Model:</span>
              <span class="info-value">{{ car?.car?.model }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Year:</span>
              <span class="info-value">{{ car?.car?.manufactureYear }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Price:</span>
              <span class="info-value">{{ formatCurrency(car?.car?.price) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Purchase Date:</span>
              <span class="info-value">{{ formatDate(car?.car?.purchaseDate) }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Supplier:</span>
              <span class="info-value">{{ car?.supplierName || car?.car?.supplierId }}</span>
            </div>
          </div>
        </div>

        <div *ngIf="car?.car?.vehicleRegistrationCertificate" class="info-card">
          <h2>Registration Certificate</h2>
          <div class="certificate-info">
            <a
              [href]="car?.car?.vehicleRegistrationCertificate"
              target="_blank"
              class="certificate-link"
            >
              <i class="pi pi-file-pdf"></i>
              View Registration Certificate
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="car-parts-section">
      <div class="parts-header">
        <h2>Car Parts ({{ filteredCarParts.length }})</h2>
        <div class="filter-controls">
          <input
            type="text"
            pInputText
            placeholder="Filter by name..."
            [(ngModel)]="filterName"
            (ngModelChange)="filterCarParts()"
            class="filter-input"
          />
          <select
            [(ngModel)]="filterStatus"
            (ngModelChange)="filterCarParts()"
            class="filter-select"
          >
            <option value="all">All Status</option>
            <option value="available">Available</option>
            <option value="sold">Sold</option>
          </select>
        </div>
      </div>
      <div *ngIf="filteredCarParts.length === 0" class="no-parts">
        <p>No car parts match the filter criteria.</p>
      </div>
      <div *ngIf="filteredCarParts.length > 0" class="parts-grid">
        <div *ngFor="let part of filteredCarParts" class="part-card">
          <div class="part-header">
            <h3>{{ part?.carPart?.name }}</h3>
            <span
              class="part-status"
              [class.available]="part?.carPart?.status === 0"
              [class.sold]="part?.carPart?.status === 1"
            >
              {{ getStatusText(part?.carPart?.status) }}
            </span>
          </div>
          <div class="part-info">
            <p class="part-price">{{ formatCurrency(part?.carPart?.price) }}</p>
            <p *ngIf="part?.buyer" class="part-buyer">Buyer: {{ part?.buyer }}</p>
          </div>
          <div *ngIf="part?.images && (part?.images?.length ?? 0) > 0" class="part-images">
            <img
              *ngFor="let image of part?.images?.slice(0, 3)"
              [src]="image"
              [alt]="part?.carPart?.name"
            />
          </div>
          <div class="part-actions" *ngIf="isAdmin">
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              (click)="openEditCarPartDialog(part)"
              class="p-button-text p-button-sm"
              title="Edit"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              (click)="deleteCarPart(part)"
              class="p-button-text p-button-danger p-button-sm"
              title="Delete"
            ></button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-car-part-dialog
    [(visible)]="carPartDialogVisible"
    [cars]="carsForDropdown"
    [selectedCarId]="carId"
    [loading]="carPartDialogLoading"
    (onSubmit)="onCarPartSubmit($event)"
  >
  </app-car-part-dialog>

  <app-edit-car-part-dialog
    [(visible)]="editCarPartDialogVisible"
    [cars]="carsForDropdown"
    [selectedCarId]="carId"
    [loading]="editCarPartDialogLoading"
    [editingCarPart]="editingCarPartData"
    (onSubmit)="onEditCarPartSubmit($event)"
  >
  </app-edit-car-part-dialog>

  <app-edit-car-dialog
    [(visible)]="editCarDialogVisible"
    [suppliers]="suppliers"
    [loading]="editCarDialogLoading"
    [editingCar]="editingCarData"
    (onSubmit)="onEditCarSubmit($event)"
  >
  </app-edit-car-dialog>
</div>
