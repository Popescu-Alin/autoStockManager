<p-dialog
  [(visible)]="visible"
  (visibleChange)="onDialogHide()"
  [modal]="true"
  [style]="{ width: '600px' }"
  [draggable]="false"
  [resizable]="false"
  header="Add Car">

  <form [formGroup]="carForm" (ngSubmit)="handleSubmit()">
    <div class="form-group" style="display: flex; align-items: center;">
      <div style="flex: 1;">
        <div style="display: flex; align-items: center;">
        <label for="supplier" class="text-align-center mb-0">Supplier <span class="required">*</span></label>
        <button type="button" pButton icon="pi pi-undo" class="p-button-text" *ngIf="showAddSupplier" (click)="onAddSupplierDialogHide()" ></button>
        </div> 
        <ng-container *ngIf="!showAddSupplier; else showSupplierFormInline">
          <div style="display: flex; align-items: center;">
          <ng-select
            id="supplier"
            formControlName="supplier"
            [items]="suppliers"
            bindLabel="label"
            bindValue="value"
            placeholder="Select a supplier"
            [clearable]="true"
            [class.ng-invalid]="carForm.get('supplier')?.invalid && carForm.get('supplier')?.touched"
            [class.ng-dirty]="carForm.get('supplier')?.dirty"
            [attr.autofocus]="false">
          </ng-select>
          <button type="button" pButton icon="pi pi-plus" class="p-button-text" *ngIf="!showAddSupplier" (click)="onAddSupplierClick()" title="Add supplier"></button>
          </div>
          <small
            class="error-message"
            *ngIf="carForm.get('supplier')?.invalid && carForm.get('supplier')?.touched">
            Supplier is required
          </small>
        </ng-container>
        <ng-template #showSupplierFormInline>
            <div class="form-group">
              <label for="supplierName">Supplier Name <span class="required">*</span></label>
              <input id="supplierName" type="text" pInputText formControlName="name" placeholder="Enter supplier name" [class.ng-invalid]="carForm.get('name')?.invalid && carForm.get('name')?.touched" [class.ng-dirty]="carForm.get('name')?.dirty" />
              <small class="error-message" *ngIf=" carForm.get('name')?.invalid && carForm.get('name')?.touched">
                <span *ngIf="carForm.get('name')?.errors?.['required']">Name is required</span>
                <span *ngIf="carForm.get('name')?.errors?.['minlength']">Name must be at least 2 characters</span>
              </small>
            </div>
            <div class="form-group">
              <label for="supplierPhone">Supplier Phone <span class="required">*</span></label>
                <input id="supplierPhone" type="tel" pInputText formControlName="phone" placeholder="(123) 456-7890" (input)="formatPhoneInline($event)" [class.ng-invalid]="carForm.get('phone')?.invalid && carForm.get('phone')?.touched" [class.ng-dirty]="carForm.get('phone')?.dirty" />
              <small class="error-message" *ngIf="carForm.get('phone')?.invalid && carForm.get('phone')?.touched">
                <span *ngIf="carForm.get('phone')?.errors?.['required']">Phone is required</span>
                <span *ngIf="carForm.get('phone')?.errors?.['pattern']">Please enter a valid phone number</span>
              </small>
            </div>
            <div class="form-group">
              <label for="supplierCnp">Supplier SSN <span class="required">*</span></label>
              <input id="supplierCnp" type="text" pInputText formControlName="ssn" placeholder="1981231123456" maxlength="13" (input)="formatCnpInline($event)" [class.ng-invalid]="carForm.get('ssn')?.invalid && carForm.get('ssn')?.touched" [class.ng-dirty]="carForm.get('ssn')?.dirty" />
              <small class="error-message" *ngIf="carForm.get('ssn')?.invalid && carForm.get('ssn')?.touched">
                <span *ngIf="carForm.get('ssn')?.errors?.['required']">SSN is required</span>
                <span *ngIf="carForm.get('ssn')?.errors?.['pattern']">CNP must be 13 digits and start with 1-8</span>
              </small>
            </div>
        </ng-template>
      </div>
    </div>

    <div class="form-group">
      <label for="purchaseDate">Purchase Date <span class="required">*</span></label>
      <input
        id="purchaseDate"
        type="date"
        pInputText
        formControlName="purchaseDate"
        [max]="maxDateString"
        [class.ng-invalid]="carForm.get('purchaseDate')?.invalid && carForm.get('purchaseDate')?.touched"
        [class.ng-dirty]="carForm.get('purchaseDate')?.dirty"
        [attr.autofocus]="false" />
      <small
        class="error-message"
        *ngIf="carForm.get('purchaseDate')?.invalid && carForm.get('purchaseDate')?.touched">
        Purchase date is required
      </small>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="brand">Brand <span class="required">*</span></label>
        <input
          id="brand"
          type="text"
          pInputText
          formControlName="brand"
          placeholder="Enter brand"
          [class.ng-invalid]="carForm.get('brand')?.invalid && carForm.get('brand')?.touched"
          [class.ng-dirty]="carForm.get('brand')?.dirty"
          [attr.autofocus]="false" />
        <small
          class="error-message"
          *ngIf="carForm.get('brand')?.invalid && carForm.get('brand')?.touched">
          <span *ngIf="carForm.get('brand')?.errors?.['required']">Brand is required</span>
          <span *ngIf="carForm.get('brand')?.errors?.['minlength']">Brand must be at least 2 characters</span>
        </small>
      </div>

      <div class="form-group">
        <label for="model">Model <span class="required">*</span></label>
        <input
          id="model"
          type="text"
          pInputText
          formControlName="model"
          placeholder="Enter model"
          [class.ng-invalid]="carForm.get('model')?.invalid && carForm.get('model')?.touched"
          [class.ng-dirty]="carForm.get('model')?.dirty"
          [attr.autofocus]="false" />
        <small
          class="error-message"
          *ngIf="carForm.get('model')?.invalid && carForm.get('model')?.touched">
          <span *ngIf="carForm.get('model')?.errors?.['required']">Model is required</span>
          <span *ngIf="carForm.get('model')?.errors?.['minlength']">Model must be at least 2 characters</span>
        </small>
      </div>
    </div>

    <div class="form-group">
      <label for="manufactureYear">Manufacture Year <span class="required">*</span></label>
      <input
        id="manufactureYear"
        type="text"
        pInputText
        formControlName="manufactureYear"
        placeholder="Enter manufacture year"
        [class.ng-invalid]="carForm.get('manufactureYear')?.invalid && carForm.get('manufactureYear')?.touched"
        [class.ng-dirty]="carForm.get('manufactureYear')?.dirty"
        [attr.autofocus]="false" />
      <small
        class="error-message"
        *ngIf="carForm.get('manufactureYear')?.invalid && carForm.get('manufactureYear')?.touched">
        <span *ngIf="carForm.get('manufactureYear')?.errors?.['required']">Manufacture year is required</span>
        <span *ngIf="carForm.get('manufactureYear')?.errors?.['min'] || carForm.get('manufactureYear')?.errors?.['max']">
          Year must be between 1900 and {{ currentYear + 1 }}
        </span>
      </small>
    </div>

    <div class="form-group">
      <label for="price">Price <span class="required">*</span></label>
      <input
        id="price"
        type="text"
        pInputText
        formControlName="price"
        placeholder="Enter price"
        [class.ng-invalid]="carForm.get('price')?.invalid && carForm.get('price')?.touched"
        [class.ng-dirty]="carForm.get('price')?.dirty"
        [attr.autofocus]="false" />
      <small
        class="error-message"
        *ngIf="carForm.get('price')?.invalid && carForm.get('price')?.touched">
        <span *ngIf="carForm.get('price')?.errors?.['required']">Price is required</span>
        <span *ngIf="carForm.get('price')?.errors?.['pattern']">Price must be a decimal number</span>
      </small>
    </div>

    <div class="form-group">
      <label for="registrationCertificate">Registration Certificate <span class="required">*</span></label>
      <div class="file-input-wrapper">
        <input
          id="registrationCertificate"
          type="file"
          accept=".pdf,.jpg,.jpeg,.png"
          (change)="onRegistrationFileSelect($event)"
          [class.ng-invalid]="!registrationFile && carForm.get('registrationCertificate')?.touched"
          [class.ng-dirty]="registrationFile !== null"
          style="display: none;" />
        <button
          type="button"
          pButton
          label="Choose File"
          icon="pi pi-upload"
          (click)="triggerFileInput('registrationCertificate')"
          class="p-button-outlined file-upload-button">
        </button>
        <button
          type="button"
          pButton
          icon="pi pi-times"
          (click)="onRegistrationFileRemove()"
          *ngIf="registrationFile"
          class="p-button-text p-button-danger remove-file-button"
          [title]="'Remove ' + registrationFile.name">
        </button>
      </div>
      <small
        class="error-message"
        *ngIf="!registrationFile && carForm.get('registrationCertificate')?.touched">
        Registration certificate is required (PDF or Image)
      </small>
      <small
        class="file-info"
        *ngIf="registrationFile">
        Selected: {{ registrationFile.name }} ({{ (registrationFile.size / 1024).toFixed(2) }} KB)
      </small>
    </div>

    <div class="form-group">
      <label for="images">Images</label>
      <div class="file-input-wrapper">
        <input
          id="images"
          type="file"
          accept="image/*"
          multiple
          (change)="onImageFilesSelect($event)"
          [class.ng-invalid]="imageFiles.length === 0 && carForm.get('images')?.touched"
          [class.ng-dirty]="imageFiles.length > 0"
          style="display: none;" />
        <button
          type="button"
          pButton
          label="Choose Images"
          icon="pi pi-upload"
          (click)="triggerFileInput('images')"
          class="p-button-outlined file-upload-button">
        </button>
        <button
          type="button"
          pButton
          icon="pi pi-times"
          (click)="onImageFilesRemove()"
          *ngIf="imageFiles.length > 0"
          class="p-button-text p-button-danger remove-file-button"
          title="Clear all images">
        </button>
      </div>
      <small
        class="error-message"
        *ngIf="imageFiles.length === 0 && carForm.get('images')?.touched">
        At least one image is required
      </small>
      <small
        class="file-info"
        *ngIf="imageFiles.length > 0">
        Selected: {{ imageFiles.length }} file(s)
        <span *ngFor="let file of imageFiles">
          <br />- {{ file.name }} ({{ (file.size / 1024).toFixed(2) }} KB)
        </span>
      </small>
    </div>

    <div class="form-actions">
      <button
        type="button"
        pButton
        label="Cancel"
        icon="pi pi-times"
        (click)="handleCancel()"
        class="p-button-danger p-button-text cancel-button"></button>
      <button
        type="submit"
        pButton
        label="Add Car"
        icon="pi pi-check"
        [disabled]="carForm.invalid || !registrationFile || imageFiles.length === 0"
        class="p-button-primary"></button>
    </div>
  </form>
</p-dialog>

